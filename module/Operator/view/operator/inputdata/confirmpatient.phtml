<?php //TODO Trad high prio ?>
<?php //TODO Empecher la validation si les données sont pas settées ?>
<ol class="breadcrumb">
	<li><a href="<?php echo $this->url('operator')?>"><span class=" glyphicon glyphicon-home"></span> <?php echo $this->translate('Operator dashboard')?></a></li>
	<li class="active"><?php echo $this->translate('Confirmation of patient\'s datas')?></li>
</ol>
<div class="row">
	<div class="col-md-10 col-md-offset-1">
		<div class="panel-body">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<span class="glyphicon glyphicon-plus-sign"></span> <?php echo $this->translate('Confirmation of patient\'s datas')?>
				</div>
				<div class="panel-body">
					<form class="form-horizontal" role="form" action="<?php echo $this->url('setup', array('action'=>'storecurrentpatient'))?>" method="POST">
						<input type="hidden" id="patient-id" name="patient_id" value="0" />
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label for="lastname" class="col-sm-4 control-label"><?php echo $this->translate('Lastname')?></label>
									<div class="col-sm-8">
										<input type="text" class="form-control input-sm" id="lastname" name="lastname" tabindex="1" placeholder="<?php echo $this->translate('ex: Martin'); ?>" autocomplete="off" required="required" />
									</div>
								</div>
								<div class="form-group">
									<label for="birthdate" class="col-sm-4 control-label"><?php echo $this->translate('Birthdate')?></label>
									<div class="col-sm-8">
										<div class="input-group date" id="datetimepicker-birthday">
											<input type="text" class="form-control" data-format="YYYY-MM-DD" id="birthdate" name="birthdate" tabindex="3" placeholder="<?php echo $this->translate('ex: 1984-03-02'); ?>" autocomplete="off" required="required" />
											<span class="input-group-addon">
												<span class="glyphicon glyphicon-calendar"></span>
											</span>
										</div>
									</div>
									<script type="text/javascript">
									$(function() {
										$('#datetimepicker-birthday').datetimepicker({
											language: 'fr',
											pickTime: false
										});
									});
									</script>
								</div>
								<div class="form-group">
									<label for="expeditornum" class="col-sm-4 control-label"><?php echo $this->translate('Expeditor number')?></label>
									<div class="col-sm-8">
										<input type="text" class="form-control input-sm" id="expeditornum" tabindex="5" placeholder="<?php echo $this->translate('ex: 754234'); ?>" autocomplete="off" required="required" />
									</div>
								</div>
								<div class="form-group">
									<label for="examinationid" class="col-sm-4 control-label"><?php echo $this->translate('Examination')?></label>
									<div class="col-sm-8">
										<select class="form-control" id="examination" name="examinationid" tabindex="7" required>
											<option value=""><?php echo $this->translate('Choisir un examen'); ?></option>
										<?php foreach($examinations as $examination) {?>
											<option value="<?php echo $examination->id;?>" data-drug-id="<?php echo $examination->drugid; ?>"><?php echo $examination->name;?></option>
										<?php } ?>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label for="drugs" class="col-sm-4 control-label"><?php echo $this->translate('Drug')?></label>
									<div class="col-sm-8">
										<select class="form-control" id="drugs" name="drugid" disabled>
											<option value=""></option>
										<?php foreach($drugs as $drug) {?>
											<option value="<?php echo $drug->id;?>"><?php echo $drug->name;?></option>
										<?php } ?>
										</select>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label for="firstname" class="col-sm-4 control-label"><?php echo $this->translate('Firstname')?></label>
									<div class="col-sm-8">
										<input type="text" class="form-control input-sm" id="firstname" name="firstname" tabindex="2" placeholder="<?php echo $this->translate('ex: Julie'); ?>" autocomplete="off" required="required" />
									</div>
								</div>
								<div class="form-group">
									<label for="weight" class="col-sm-4 control-label"><?php echo $this->translate('Weight');?></label>
									<div class="col-sm-8">
										<div class="input-group">
											<input type="number" class="form-control input-sm" id="weight" name="weight" tabindex="4" autocomplete="off" placeholder="<?php echo $this->translate('ex: 72'); ?>" required="required" />
											<span class="input-group-addon">Kg</span>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="comments" class="col-sm-4 control-label"><?php echo $this->translate('Comments');?></label>
									<div class="col-sm-8">
										<textarea style="resize:none" class="form-control input-sm" id="comments" name="comments" tabindex="6" rows="3" placeholder="<?php echo $this->translate("Commentaire sur l'examen du patient");?>"></textarea>
									</div>
								</div>
								<div class="form-group">
									<label for="activity" class="col-sm-8 control-label"><?php echo $this->translate('Activity for examination');?></label>
									<div class="col-sm-4">
										<div class="input-group">
											<input type="number" class="form-control input-sm" id="activity" name="activity" tabindex="8" autocomplete="off" required="required" />
											<span class="input-group-addon"><?php echo $unit?></span>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="activityavailable" class="col-sm-8 control-label"><?php echo $this->translate('Activity available at')?> <span id="activity-time">HH.MM</span></label>
									<div class="col-sm-4">
										<div class="input-group">
											<input type="text" class="form-control input-sm" id="activityavailable" name="activityavailable" value="???" autocomplete="off" readonly />
											<span class="input-group-addon"><?php echo $unit?></span>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row well">
							<div class="col-md-4">
								<div class="form-group">
									<label for="averageactivity" class="col-sm-4 control-label"><?php echo $this->translate('Average activity for examination');?></label>
									<div class="col-sm-8">
										<div class="input-group">
											<input type="text" class="form-control input-sm" id="averageactivity" name="averageactivity" autocomplete="off" disabled />
											<span class="input-group-addon"><?php echo $unit?>/kg</span>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="form-group">
									<label for="minactivity" class="col-sm-4 control-label"><?php echo $this->translate('Minimal activity for examination');?></label>
									<div class="col-sm-8">
										<div class="input-group">
											<input type="text" class="form-control input-sm" id="minactivity" name="minactivity" autocomplete="off" disabled />
											<span class="input-group-addon"><?php echo $unit?></span>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="form-group">
									<label for="maxactivity" class="col-sm-4 control-label"><?php echo $this->translate('Maximal activity for examination');?></label>
									<div class="col-sm-8">
										<div class="input-group">
											<input type="text" class="form-control input-sm" id="maxactivity" name="maxactivity" autocomplete="off" disabled />
											<span class="input-group-addon"><?php echo $unit?></span>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-2 col-md-offset-1">
								<input type="submit" class="btn btn-success btn-block" value="<?php echo $this->translate('Next');?>" />
							</div>
							<div class="col-md-2">
								<button type="button" class="btn btn-primary btn-block" onclick="setMinActivity()"><?php echo $this->translate('Min Activity')?></button>
							</div>
							<div class="col-md-2">
								<button type="button" class="btn btn-primary btn-block" onclick="setMaxActivity()"><?php echo $this->translate('Max Activity')?></button>
							</div>
							<div class="col-md-2">
								<button type="button" class="btn btn-primary btn-block" onclick="setNormActivity()"><?php echo $this->translate('Rate')?></button>
							</div>
							<div class="col-md-2">
								<button type="button" class="btn btn-danger btn-block" onclick="cancelPatient();"><?php echo $this->translate('Abort');?></button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="alertlowactivity" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><span class="glyphicon glyphicon-warning-sign"></span> <?php echo $this->translate('Insufficient activity');?></h4>
			</div>
			<div class="modal-body">
				<?php echo $this->translate('Insufficient activity. Do you want to correct it ?');?>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" onclick="lowActivityOperatorResponse('correct');"><?php echo $this->translate('YES');?></button>
				<button type="button" class="btn btn-danger" onclick="lowActivityOperatorResponse('ignore');"><?php echo $this->translate('NO');?></button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="alertchoosepatient" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><span class="glyphicon glyphicon-warning-sign"></span> <?php echo $this->translate('Insufficient activity');?></h4>
			</div>
			<div class="modal-body">
				<p><?php echo $this->translate('Insufficient activity. You have choose to don\'t change the activity.'); ?></p>
				<div class="alert alert-info">
					<i class="glyphicon glyphicon-question-sign"></i>
					<?php echo $this->translate('Do you want to create / choose another patient ?'); ?>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" onclick="lowActivityOperatorResponse('choose');"><?php echo $this->translate('YES');?></button>
				<button type="button" class="btn btn-danger" onclick="lowActivityOperatorResponse('abort');"><?php echo $this->translate('NO');?></button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	function	cancelPatient()
	{
		$.ajax({
			url: "<?php echo $this->url('setup', array('action' => 'acancelpatient'));?>",
			type: "GET",
			dataType: "json",
		}).done(function(result) {
			location.href = '<?php echo $this->url('operator'); ?>';
		});
	}
									
	function	setMinActivity()
	{
		$.ajax({
			url: "<?php echo $this->url('setup', array('action'=>'asetactivity'));?>",
			type: "POST",
			dataType: "json",
			data: {"min" : 1}
		}).done(function(result) {
			$('#activity').val(result.activity);
		});
	}

	function	setMaxActivity()
	{
		$.ajax({
			url: "<?php echo $this->url('setup', array('action'=>'asetactivity'));?>",
			type: "POST",
			dataType: "json",
			data: {"max" : 1}
		}).done(function(result) {
			$('#activity').val(result.activity);
		});
	}

	function	setNormActivity()
	{
		$.ajax({
			url: "<?php echo $this->url('setup', array('action'=>'asetactivity'));?>",
			type: "POST",
			dataType: "json",
			data: {"norm" : 1}
		}).done(function(result) {
			$('#activity').val(result.activity);
		});
	}

	function	loadExamination(examinationid)
	{
		$.ajax({
			url: "<?php echo $this->url('setup', array('action'=>'aloadexamination'));?>",
			type: "POST",
			data: { 'examinationid': examinationid },
			dataType: "json"
		}).done(function(result) {
			$('#averageactivity').val(result.rate);
			$('#minactivity').val(result.min);
			$('#maxactivity').val(result.max);
			$('#drugs').val(result.drugid);
			$.ajax({
				url: "<?php echo $this->url('setup', array('action'=>'aupdatepatient'));?>",
				type: "POST",
				dataType: "json"
			}).done(function(result) {
				$('#activity').val(result.activity);
			});
		});

	}

	function	loadInjection(patientid)
	{
		$.ajax({
			url: "<?php echo $this->url('bufferspace', array('action'=>'aloadinjection'));?>",
			type: "POST",
			data: { 'patientid': patientid },
			dataType: "json"
		}).done(function(result) {
			$('#activity').val(result.activity);
			$('#comments').val(result.comments);
			$('#expeditornum').val(result.unique_id);
			if (result.drugid > 0) {
				$('#drugs').val(result.drugid);
			}
			if (result.examinationid > 0)  {
				$('#examination').val(result.examinationid);
				loadExamination(result.examinationid);
			}
			$.ajax({
				url: "<?php echo $this->url('setup', array('action'=>'aupdatepatient'));?>",
				type: "POST",
				data: { 'activity': result.activity, "expeditornum" : result.unique_id },
				dataType: "json"
			}).done(function(result) {
				$('#activity').val(result.activity);
			});
		});
	}

	function	loadPatient(patientid)
	{
		$('tr.info').removeClass('info');
		$('#patient-'+patientid).addClass('info');
		$.ajax({
			url: "<?php echo $this->url('bufferspace', array('action'=>'aloadpatient'));?>",
			type: "POST",
			data: { 'patientid': patientid },
			dataType: "json"
		}).done(function(result) {
			$('#patient-id').val(result.id);
			$('#lastname').val(result.lastname);
			$('#firstname').val(result.firstname);
			$('#gender').val(result.gender);
			$('#datetimepicker-birthday').data('DateTimePicker').setDate(result.birthdate);
			$('#age').val(result.age);
			$('#weight').val(result.weight);
			$('#height').val(result.height);
			$.ajax({
				url: "<?php echo $this->url('setup', array('action'=>'aupdatepatient'));?>",
				type: "POST",
				data: { 'lastname': result.lastname, 'firstname' : result.firstname, 'birthdate': result.birthdate, "weight" : result.weight },
				dataType: "json"
			});
		});
		$('#btn-next').removeAttr('disabled');
	}
	
	function	loadActivityData()
	{
		$.ajax({
			type: "GET",
			url: "<?php echo $this->url('setup', array('action'=>'agetavailableactivity'))?>",
			dataType: "json"
		}).done(function(result) {
			var data = result;
			$("#activity-time").html(data.time);
			$("#activityavailable").val(data.activity);
			if(Number(data.activity) < Number($("#activity").val()))
			{
				$("#alertlowactivity").modal('show');
			}
		});
		//setTimeout(function(){loadActivityData();}, 5000);
	}
	
	function	lowActivityOperatorResponse(response)
	{
		$('#alertlowactivity').modal('hide');
		$('#alertchoosepatient').modal('hide');
		
		if (response == 'correct') {
			$('#activity').val('');
			$('#activity').focus();
		} else if (response == 'ignore') {
			$("#alertchoosepatient").modal('show');
		} else if (response == 'choose') {
			location.href = '<?php echo $this->url('setup', array('action'=>'selectpatient'));?>';
		} else if (response == 'abort') {
			location.href = '<?php echo $this->url('operator');?>';
		}
		//TODO Appel pour mettre un log en base de donnée
		
	}

	$(function(){
		loadPatient(<?php echo $patientid;?>);
		loadInjection(<?php echo $patientid;?>);
		loadActivityData();
		
		$('#examination').change(function(){
			loadExamination($('#examination').val());
		});
		
		$('#activity').change(function (){
				$.ajax({
				url: "<?php echo $this->url('setup', array('action'=>'asetactivity'));?>",
				type: "POST",
				data: { "activity" : $('#activity').val() },
				dataType: "json"
			}).done(function(result) {
				$('#activity').val(result.activity);
				loadActivityData();
			});	
		});

		$('#alertlowactivity').on('hidden.bs.modal', function (e) {
			  // do something...
		});
		
		$('#weight').change(function (){
				$.ajax({
				url: "<?php echo $this->url('setup', array('action'=>'aupdatepatient'));?>",
				type: "POST",
				data: { "weight" : $('#weight').val() },
				dataType: "json"
			}).done(function(result) {
				$('#activity').val(result.activity);
			});	
		});
	});
</script>
